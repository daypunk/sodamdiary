---
alwaysApply: true
description: STT 통합 기반 소담일기 리팩토링 가이드
---

# STT 통합 기반 소담일기 리팩토링 가이드

## 프로젝트 개요
- **앱 목적**: 시각장애인을 위한 카메라&갤러리 앱
- **핵심 가치**: TalkBack 친화적 UX (접근성 최우선)
- **기술 스택**: Kotlin, Jetpack Compose, Room, Retrofit2
- **아키텍처**: 단일 Activity + Compose 네비게이션, Repository 패턴

## 리팩토링 목표
이번 리팩토링은 기존 텍스트 입력 방식을 **음성 중심 인터페이스**로 전환하여 시각장애인 사용자의 경험을 개선합니다.

### 주요 변경 사항
1. **촬영 후 정보 입력**: 텍스트 타이핑 → **단일 STT 버튼** (녹음 + 전사 동시 진행)
2. **갤러리 검색**: 다단계 스크린 → **단일 STT 검색 버튼**
3. **사진 상세 화면**: 일기 낭독 + **사용자 음성 재생 기능** 추가

---

## 현재 코드베이스 구조

### 네비게이션 구조
- [MainActivity.kt](mdc:app/src/main/java/com/example/sodam_diary/MainActivity.kt): 단일 액티비티 + `AppNavigation` Composable
- 촬영 플로우: `CameraScreen` → `PhotoPreviewScreen` → `PhotoInfoChoiceScreen` → `PhotoDetailScreen`
- 검색 플로우: `GalleryScreen` → `SearchStep1~4Screen` → `SearchResultScreen`

### TalkBack 친화적 레이아웃
- [ScreenLayout.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/components/ScreenLayout.kt): 모든 화면의 공통 레이아웃
  - **핵심 기능**: 헤더가 먼저 읽히지 않도록 `suppressHeaderUntilFocused` 지연 로직
  - **포커스 제어**: `initialFocusRequester`로 주요 콘텐츠 우선 포커스
  - **traversalIndex**: 접근성 읽기 순서 제어 (0: 콘텐츠, 1: 하단 버튼, 2: 헤더)
  - **contentDescription**: 명확한 음성 안내 레이블

### 데이터 계층
- [PhotoEntity.kt](mdc:app/src/main/java/com/example/sodam_diary/data/entity/PhotoEntity.kt): 사진 데이터 모델 (현재 DB 버전 2)
- [PhotoDao.kt](mdc:app/src/main/java/com/example/sodam_diary/data/database/PhotoDao.kt): Room DAO (검색 쿼리 포함)
- [AppDatabase.kt](mdc:app/src/main/java/com/example/sodam_diary/data/database/AppDatabase.kt): Room Database 설정
- [PhotoRepository.kt](mdc:app/src/main/java/com/example/sodam_diary/data/repository/PhotoRepository.kt): 데이터 저장/조회 로직
- [ApiService.kt](mdc:app/src/main/java/com/example/sodam_diary/data/network/ApiService.kt): Retrofit API 인터페이스
- [NetworkClient.kt](mdc:app/src/main/java/com/example/sodam_diary/data/network/NetworkClient.kt): Base URL `http://52.63.210.142`

### 유틸리티
- [ImageUtils.kt](mdc:app/src/main/java/com/example/sodam_diary/utils/ImageUtils.kt): `PhotoManager` 클래스로 사진 파일 관리
- [LocationHelper.kt](mdc:app/src/main/java/com/example/sodam_diary/utils/LocationHelper.kt): 위치 정보 조회

---

## 새로운 데이터베이스 스키마

### PhotoEntity 변경 사항 (DB 버전 2 → 3)
```kotlin
@Entity(tableName = "photos")
data class PhotoEntity(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    
    // 기존 필드
    val photoPath: String,              // 사진 파일 경로
    val captureDate: Long,              // 촬영 타임스탬프
    val latitude: Double?,              // 위도
    val longitude: Double?,             // 경도
    val locationName: String?,          // 주소/장소명
    val imageDescription: String?,      // LLM 생성 일기 (기존: 서버 설명)
    val userDescription: String?,       // STT로 변환된 사용자 입력
    
    // 신규 필드 추가
    val userVoicePath: String?,         // 사용자 음성 파일 경로 (*.m4a)
    val caption: String?,               // BLIP 기반 이미지 캡션
    val tags: String?                   // 태그 목록 (쉼표 구분: "태그1,태그2,태그3")
)
```

### Migration 3 작성 필요
- `AppDatabase.kt`에서 `MIGRATION_2_3` 추가
- `userVoicePath`, `caption`, `tags` 컬럼 추가 (모두 nullable TEXT)

---

## 새로운 API 플로우

### 서버 Base URL
```
http://52.63.210.142
```

### API 1단계: 이미지 분석 (BLIP 캡션)
**Endpoint**: `POST /api/v1/analyze/`

**Request**:
```
Content-Type: multipart/form-data
- image_file: (file) 촬영한 사진
```

**Response**:
```json
{
  "caption": "string"
}
```

**타이밍**: 사진 촬영 후 `PhotoInfoChoiceScreen` 진입 시 백그라운드에서 호출
**저장**: `caption` 필드에 저장

### API 2단계: 일기 생성 (LLM)
**Endpoint**: `POST /api/v1/generate/`

**Request**:
```json
{
  "user_input": "string",      // userDescription (STT 전사 텍스트)
  "blip_caption": "string"     // caption (1단계에서 받은 값)
}
```

**Response**:
```json
{
  "diary": "string",           // LLM 생성 일기
  "tags": ["string"]           // 태그 배열
}
```

**타이밍**: 사용자가 STT 입력 완료 후 `PhotoDetailScreen` 진입 전
**저장**: 
- `diary` → `imageDescription` 필드
- `tags` → `tags` 필드 (배열을 쉼표 구분 문자열로 변환)

### ApiService.kt 수정 필요
```kotlin
interface ApiService {
    // 기존 analyzePhoto 제거
    
    @Multipart
    @POST("api/v1/analyze/")
    suspend fun analyzeImage(
        @Part image_file: MultipartBody.Part
    ): Response<AnalyzeResponse>
    
    @POST("api/v1/generate/")
    suspend fun generateDiary(
        @Body request: GenerateRequest
    ): Response<GenerateResponse>
}

data class AnalyzeResponse(
    val caption: String
)

data class GenerateRequest(
    val user_input: String,
    val blip_caption: String
)

data class GenerateResponse(
    val diary: String,
    val tags: List<String>
)
```

---

## STT 통합 구현 가이드

### 음성 녹음 & STT 처리
**권장 방식**: 안드로이드 기본 `SpeechRecognizer` + `MediaRecorder` 조합

#### VoiceRecorder 유틸리티 클래스 (신규 생성)
- **위치**: `app/src/main/java/com/example/sodam_diary/utils/VoiceRecorder.kt`
- **책임**:
  1. 음성 녹음 시작/중지 (`MediaRecorder`)
  2. STT 시작/중지 (`SpeechRecognizer`)
  3. 녹음 파일 저장 경로 생성 (`filesDir/voices/voice_<timestamp>.m4a`)
  4. 전사된 텍스트 결과 콜백

#### 파일 관리
- **저장 경로**: `context.filesDir/voices/`
- **파일명**: `voice_<timestamp>.m4a`
- **삭제 로직**: 사진 삭제 시 연관 `userVoicePath` 파일도 함께 삭제

### TalkBack 친화적 STT 버튼 구현 원칙
1. **명확한 음성 안내**:
   ```kotlin
   modifier = Modifier.semantics {
       contentDescription = "말씀하시면 바로 녹음하고 글자로 바꿔드려요. 버튼을 눌러주세요"
   }
   ```

2. **상태 변화 즉시 알림**:
   ```kotlin
   val view = LocalView.current
   // 녹음 시작 시
   view.announceForAccessibility("녹음이 시작되었습니다. 말씀해주세요")
   // 녹음 중지 시
   view.announceForAccessibility("녹음이 완료되었습니다")
   ```

3. **토글형 UI**:
   - 대기 중: "녹음 시작" 버튼
   - 녹음 중: "녹음 중지" 버튼 (빨간색 배경, 진동 효과)

4. **오류 처리**:
   - STT 실패: "음성을 인식할 수 없습니다. 다시 시도해주세요"
   - 사용자 취소: "녹음이 취소되었습니다"
   - 권한 거부: "마이크 권한이 필요합니다"

---

## 화면별 리팩토링 상세

### 1. PhotoInfoChoiceScreen → STT 통합 화면
**파일**: [PhotoInfoChoiceScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/PhotoInfoChoiceScreen.kt)

#### 변경 내용
- **기존**: "추가하기" 버튼 → 텍스트 입력 다이얼로그
- **신규**: "추가하기" 버튼 → **음성 녹음 다이얼로그**
  - 단일 STT 버튼 (토글: 녹음 시작 / 녹음 중지)
  - 전사 중 상태 표시: "음성을 글자로 바꾸고 있어요..."
  - 완료 시 자동으로 다음 화면 이동

#### 백그라운드 작업
- 화면 진입 시 `PhotoRepository.analyzeImage(photoPath)` 호출
- `caption` 결과를 상태로 저장
- 사용자가 STT 완료 후 → `generateDiary(userDescription, caption)` 호출
- 두 API 모두 완료되면 → `PhotoDetailScreen`으로 네비게이션

#### 오류 처리
- API 1단계 실패: `caption = null`로 진행 (일기 생성 시 caption 없이 요청)
- API 2단계 실패: `imageDescription = "일기 생성에 실패했습니다"`, `tags = null`
- STT 실패: 다이얼로그 유지, "다시 시도" 버튼 제공

#### ScreenLayout 통합
```kotlin
ScreenLayout(
    initialFocusRequester = titleFocus,
    contentFocusLabel = "사진에 정보를 추가할까요?",
    suppressHeaderUntilFocused = true
) {
    // 기존 레이아웃 + STT 다이얼로그
}
```

### 2. GalleryScreen → STT 검색 통합
**파일**: [GalleryScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/GalleryScreen.kt)

#### 변경 내용
- **기존**: "검색하기" 버튼 → `SearchStep1Screen` 네비게이션
- **신규**: "검색하기" 버튼 → **음성 검색 다이얼로그**
  - STT 버튼으로 검색어 입력
  - 전사 완료 시 즉시 검색 실행
  - 결과를 `SearchResultScreen` 또는 `GalleryScreen` 내 상태로 표시

#### 검색 로직
```kotlin
suspend fun searchPhotosByVoice(query: String): List<PhotoEntity> {
    return photoDao.searchByQuery(query)
}

// PhotoDao.kt에 추가
@Query("""
    SELECT * FROM photos 
    WHERE caption LIKE '%' || :query || '%' 
    OR tags LIKE '%' || :query || '%'
    ORDER BY captureDate DESC
""")
suspend fun searchByQuery(query: String): List<PhotoEntity>
```

#### UI 플로우
1. 검색 버튼 클릭 → 다이얼로그 표시
2. STT 버튼으로 음성 입력 (예: "산에서 찍은 사진")
3. 전사 완료 → 검색 실행
4. 결과 표시:
   - 결과 있음: `SearchResultScreen`으로 이동 또는 `GalleryScreen` 상태 갱신
   - 결과 없음: "검색 결과가 없습니다" 음성 안내

#### 기존 SearchStep1~4Screen 처리
- **삭제 대상**: `SearchStep1Screen.kt`, `SearchStep2Screen.kt`, `SearchStep3Screen.kt`, `SearchStep4Screen.kt`
- `MainActivity.kt`의 네비게이션 라우트에서 제거
- `SearchResultScreen`은 유지 (갤러리 검색 결과 표시용)

### 3. PhotoDetailScreen → 음성 재생 버튼 추가
**파일**: [PhotoDetailScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/PhotoDetailScreen.kt)

#### 변경 내용
- 기존 "갤러리로" 버튼 위에 **"내 목소리 듣기"** 버튼 추가
- `photoEntity.userVoicePath`가 있을 때만 버튼 표시

#### 음성 재생 로직
```kotlin
// VoicePlayer 유틸리티 (신규 생성)
class VoicePlayer(private val context: Context) {
    private var mediaPlayer: MediaPlayer? = null
    
    fun playVoice(voicePath: String) {
        mediaPlayer?.release()
        mediaPlayer = MediaPlayer().apply {
            setDataSource(voicePath)
            prepare()
            start()
        }
    }
    
    fun stopVoice() {
        mediaPlayer?.stop()
        mediaPlayer?.release()
        mediaPlayer = null
    }
}
```

#### UI 구현
```kotlin
Column(
    modifier = Modifier.padding(24.dp),
    verticalArrangement = Arrangement.spacedBy(16.dp)
) {
    // 조건부 렌더링
    if (!photoEntity?.userVoicePath.isNullOrBlank()) {
        Button(
            onClick = { voicePlayer.playVoice(photoEntity!!.userVoicePath!!) },
            modifier = Modifier
                .fillMaxWidth()
                .height(60.dp)
                .semantics { 
                    contentDescription = "내 목소리 듣기, 사진을 찍을 때 녹음한 음성을 들을 수 있어요" 
                },
            colors = ButtonDefaults.buttonColors(
                containerColor = Color(0xFF4CAF50), // 초록색
                contentColor = Color.White
            )
        ) {
            Text("내 목소리 듣기", fontSize = 22.sp, fontWeight = FontWeight.Bold)
        }
    }
    
    // 기존 "갤러리로" 버튼
    Button(...) { ... }
}
```

#### 접근성 개선
- 재생 중일 때 버튼 텍스트: "재생 중지"
- 재생 시작 시: `view.announceForAccessibility("음성을 재생합니다")`
- 재생 완료 시: `view.announceForAccessibility("재생이 완료되었습니다")`

---

## TalkBack 친화적 개발 원칙 (필수 준수)

### 1. 포커스 순서 제어
- **ScreenLayout 활용**: 모든 화면에서 `initialFocusRequester` 사용
- **traversalIndex 설정**:
  - 0: 주요 콘텐츠 (타이틀, 본문)
  - 1: 하단 액션 버튼
  - 2: 상단 헤더 (홈/뒤로가기 버튼)

### 2. 헤더 지연 로딩
- `suppressHeaderUntilFocused = true` (기본값 유지)
- 헤더가 먼저 읽히면 사용자 혼란 유발 → **절대 금지**

### 3. 명확한 contentDescription
- **나쁜 예**: "버튼", "이미지"
- **좋은 예**: "카메라로 사진 촬영하기", "2024년 12월 25일에 찍은 사진이에요"

### 4. 상태 변화 즉시 알림
- `LocalView.current.announceForAccessibility()` 활용
- 로딩 시작/완료, 오류 발생, 작업 완료 등 모든 상태 변화에 음성 안내

### 5. 버튼 크기 및 간격
- 최소 터치 타겟: 48dp × 48dp
- 버튼 간 간격: 16dp 이상 (실수 터치 방지)

### 6. 오류 메시지 친절하게
- **나쁜 예**: "Error 404"
- **좋은 예**: "네트워크 연결이 끊어졌어요. 잠시 후 다시 시도해주세요"

---

## 파일 관리 정책

### 음성 파일 저장
- **경로**: `context.filesDir/voices/`
- **파일명**: `voice_<timestamp>.m4a`
- **용량 관리**: 사진 삭제 시 연관 음성 파일도 함께 삭제

### 사진 삭제 로직 수정
```kotlin
// PhotoRepository.kt
suspend fun deletePhoto(photo: PhotoEntity) {
    // 1. 음성 파일 삭제
    photo.userVoicePath?.let { voicePath ->
        File(voicePath).delete()
    }
    
    // 2. 사진 파일 삭제
    File(photo.photoPath).delete()
    
    // 3. DB에서 삭제
    photoDao.deletePhoto(photo)
}
```

---

## 테스트 체크리스트

### TalkBack 환경 테스트
- [ ] 촬영 → STT 입력 → 상세 화면 흐름에서 헤더가 먼저 읽히지 않는가?
- [ ] STT 버튼 클릭 시 명확한 음성 안내가 나오는가?
- [ ] 녹음 시작/중지 상태 변화가 즉시 TalkBack으로 전달되는가?
- [ ] 갤러리 검색 시 결과 안내가 먼저 읽히고 사진 목록이 이어지는가?
- [ ] 상세 화면의 "내 목소리 듣기" 버튼이 적절히 안내되는가?

### 오류 처리 테스트
- [ ] STT 실패 시 재시도 옵션이 제공되는가?
- [ ] API 1단계(analyze) 실패 시에도 사진 저장이 가능한가?
- [ ] API 2단계(generate) 실패 시 적절한 에러 메시지가 표시되는가?
- [ ] 사용자가 STT 취소 시 깔끔하게 초기화되는가?
- [ ] 마이크 권한 거부 시 명확한 안내가 제공되는가?

### 데이터 무결성 테스트
- [ ] 음성 파일과 전사 텍스트가 모두 정상 저장되는가?
- [ ] BLIP caption과 LLM 일기가 올바른 필드에 저장되는가?
- [ ] tags 배열이 쉼표 구분 문자열로 정확히 변환되는가?
- [ ] 사진 삭제 시 연관 음성 파일도 함께 삭제되는가?

### 네트워크 오류 처리
- [ ] 오프라인 상태에서 사진 저장 시 로컬 저장만 진행되는가?
- [ ] 타임아웃 발생 시 적절한 안내가 제공되는가?
- [ ] 서버 응답 지연 시 로딩 상태가 명확히 표시되는가?

---

## 구현 우선순위

### Phase 1: 데이터 계층 (DB + API)
1. `PhotoEntity`에 `userVoicePath`, `caption`, `tags` 필드 추가
2. `AppDatabase` Migration 2→3 작성
3. `ApiService` 수정 (analyze, generate 엔드포인트)
4. `PhotoRepository` 수정 (2단계 API 호출 로직)

### Phase 2: 유틸리티 (음성 녹음/재생)
1. `VoiceRecorder.kt` 생성 (STT + MediaRecorder 통합)
2. `VoicePlayer.kt` 생성 (MediaPlayer 래퍼)
3. 파일 저장 경로 관리 로직

### Phase 3: UI 리팩토링
1. `PhotoInfoChoiceScreen` → STT 통합 다이얼로그
2. `GalleryScreen` → STT 검색 버튼
3. `PhotoDetailScreen` → 음성 재생 버튼 추가
4. `SearchStep1~4Screen` 삭제 및 네비게이션 정리

### Phase 4: 테스트 및 접근성 검증
1. TalkBack 환경 전체 플로우 테스트
2. 오류 처리 시나리오 검증
3. 네트워크 실패 상황 테스트

---

## 주의사항

### 코드 복잡도 제한
- **금지**: MVVM, MVI 등 복잡한 아키텍처 패턴 도입
- **권장**: Repository 패턴 유지, 단순한 상태 관리 (`remember`, `mutableStateOf`)

### 파일 수 최소화
- 새 파일 생성 최소화
- 유틸리티는 `utils/` 패키지에 통합
- 기존 파일 수정 우선, 불가피할 때만 신규 생성

### 시각장애인 우선 설계
- 모든 UI 변경은 **TalkBack 친화성**을 최우선으로 고려
- 시각적 디자인보다 **음성 안내 명확성**이 우선
- 복잡한 제스처 금지, 단순한 탭/스와이프만 사용

### 서버 의존성 최소화
- 네트워크 실패 시에도 로컬 저장은 항상 성공
- API 호출은 백그라운드에서 비동기로 처리
- 사용자는 서버 응답을 기다리지 않고 다음 단계 진행 가능

---

## 참고 파일 인덱스

### 핵심 파일
- [MainActivity.kt](mdc:app/src/main/java/com/example/sodam_diary/MainActivity.kt) - 네비게이션 구조
- [ScreenLayout.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/components/ScreenLayout.kt) - TalkBack 친화적 레이아웃
- [PhotoEntity.kt](mdc:app/src/main/java/com/example/sodam_diary/data/entity/PhotoEntity.kt) - 데이터 모델
- [AppDatabase.kt](mdc:app/src/main/java/com/example/sodam_diary/data/database/AppDatabase.kt) - Room 설정
- [PhotoRepository.kt](mdc:app/src/main/java/com/example/sodam_diary/data/repository/PhotoRepository.kt) - 데이터 로직

### 리팩토링 대상 화면
- [PhotoInfoChoiceScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/PhotoInfoChoiceScreen.kt) - STT 통합 필요
- [GalleryScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/GalleryScreen.kt) - STT 검색 통합
- [PhotoDetailScreen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/PhotoDetailScreen.kt) - 음성 재생 추가

### 삭제 예정
- [SearchStep1Screen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/SearchStep1Screen.kt)
- [SearchStep2Screen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/SearchStep2Screen.kt)
- [SearchStep3Screen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/SearchStep3Screen.kt)
- [SearchStep4Screen.kt](mdc:app/src/main/java/com/example/sodam_diary/ui/screens/SearchStep4Screen.kt)

### 유틸리티
- [ImageUtils.kt](mdc:app/src/main/java/com/example/sodam_diary/utils/ImageUtils.kt) - PhotoManager 클래스
- [LocationHelper.kt](mdc:app/src/main/java/com/example/sodam_diary/utils/LocationHelper.kt) - 위치 정보

---

## 버전 관리
- **현재 DB 버전**: 2
- **리팩토링 후 DB 버전**: 3
- **기준 커밋**: feat/api-refactoring 브랜치
